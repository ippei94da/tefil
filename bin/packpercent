#! /usr/bin/env ruby
# coding: utf-8
#
# USAGE: linesub [options] str0 str1 files ...

require "pp"
require "optparse"
require "rubygems"
#gem "tefil"
require "tefil.rb"

## option analysis
OPTIONS = {}
op = OptionParser.new
op.banner = [
    "Usage: #{File.basename("#{__FILE__}")} [options] [files]",
    #"  E.g., echo '%E3%83%86%E3%82%B9%E3%83%88' | packpercent" #テスト
    "  E.g., echo '%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB' | packpercent" #サンプル
].join("\n")
op.on("-o"    , "--overwrite"    , "Overwrite."){    OPTIONS[:overwrite] = true}
op.parse!(ARGV)

module Tefil
  def self.process_stream(in_io, out_io)
    in_io.each do |line|
      old_chars = line.split("")

      new_str = ""
      new_index = 0
      old_index = 0
      while old_index < old_chars.size
        if old_chars[old_index] == "%"
          new_str += [old_chars[(old_index +1) .. (old_index + 2)].join].pack("H*")
          old_index += 2
        else
          new_str += old_chars[old_index]
        end
        old_index += 1
        new_index += 1
      end
      out_io.print new_str
    end
  end
end

OPTIONS[:overwrite] ||= false

Tefil.run(ARGV, OPTIONS[:overwrite])
