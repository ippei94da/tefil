#! /usr/bin/env ruby
# coding: utf-8
#
# USAGE: linesub [options] str0 str1 files ...

require "pp"
require "optparse"
require "rubygems"
#gem "tefil"
require "tefil.rb"

## option analysis
OPTIONS = {}
op = OptionParser.new
op.on("-o"    , "--overwrite"    , "Overwrite."){    OPTIONS[:overwrite] = true}
op.on("-g"    , "--global"    , "Globally substitute."){    OPTIONS[:global] = true}
op.parse!(ARGV)

OLD_PATTERN = ARGV.shift
NEW_STR = ARGV.shift

module TextFilter
  def self.process_stream(in_io, out_io)
    in_io.each do |line|
      if OPTIONS[:global]
        out_io.puts line.gsub(OLD_PATTERN, NEW_STR)
      else
        out_io.puts line.sub(OLD_PATTERN, NEW_STR)
      end
    end
  end
end

OPTIONS[:overwrite] ||= false

TextFilter.run(ARGV, OPTIONS[:overwrite])
